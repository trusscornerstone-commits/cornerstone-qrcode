<!DOCTYPE html>
<html lang="pt-BR">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Cornerstone - Home</title>
  <link rel="stylesheet" href="{% static 'accounts/home.css' %}">
  <body>
  <div class="logo">
    <img src="{% static 'accounts/cornerstone_logo.png' %}" alt="Cornerstone Logo">
  </div>

  <div class="home-container">
    <h2>Main Menu</h2>

    <button class="menu-btn" id="qrBtn" type="button">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="#fff" viewBox="0 0 24 24">
        <path d="M3 3h8v8H3V3zm2 2v4h4V5H5zM13 3h8v8h-8V3zm2 2v4h4V5h-4zM3 13h8v8H3v-8zm2 2v4h4v-4H5zM13 13h8v8h-8v-8zm2 2v4h4v-4h-4z"/>
      </svg>
        Scan QR Code
    </button>

    <button class="menu-btn" id="inventoryBtn" type="button" data-open-new-tab="1">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="#fff" viewBox="0 0 24 24">
        <path d="M3 3v18h18V3H3zm16 16H5V5h14v14zM7 7h10v2H7V7zm0 4h10v2H7v-2z"/>
      </svg>
        Inventory
      </button>

    <button class="menu-btn" id="fieldwireBtn" type="button" data-open-new-tab="1">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="#fff" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2C6.477 2 2 6.477 2 12v2h20v-2c0-5.523-4.477-10-10-10zm0 16a6 6 0 0 1-6-6h12a6 6 0 0 1-6 6z"/>
    </svg>
      <span>Fieldwire</span>
    </button>

    <button class="menu-btn" id="asanaBtn" type="button" data-open-new-tab="1">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="#fff"; fill: currentColor;>
      <circle cx="12" cy="17" r="3"/>
      <circle cx="7" cy="9" r="3"/>
      <circle cx="17" cy="9" r="3"/>
    </svg>
      <span>Asana</span>
    </button>

    <button class="menu-btn" id="reportBtn" type="button" data-open-new-tab="1">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="#fff"; fill: currentColor;>
      <rect x="4" y="10" width="3" height="10"/>
      <rect x="10" y="6" width="3" height="14"/>
      <rect x="16" y="2" width="3" height="18"/>
    </svg>
      <span>Reports</span>
    </button>
  </div>

  <div class="footer"></div>

  <script>
    window.APP_CONFIG = {
      urls: {
        trussDetailBase: "/truss-detail/",
        scanTruss: "{% url 'scan_truss' %}",
        underConstruction: "{% url 'em_construcao' %}"
      },
      trussDetailUrl(pk) { return this.urls.trussDetailBase + pk + "/"; }
    };

    const isIOS = /iP(hone|ad|od)/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    const isMobile = isIOS || isAndroid;

    // Map de apps
    const SERVICES = {
      inventory: {
        schemeCandidates: ['sortly://'],           
        web: 'https://www.sortly.com/',
        fallbackDelay: 1200
      },
      fieldwire: {
        schemeCandidates: ['fieldwire://'],        
        web: 'https://www.fieldwire.com/',
        fallbackDelay: 1200
      },
      asana: {
        schemeCandidates: ['asana://app', 'asana://'],
        web: 'https://app.asana.com/',
        fallbackDelay: 1200
      },
      reports: {
        schemeCandidates: ['powerbi://app', 'powerbi://'],
        web: 'https://app.powerbi.com/',
        fallbackDelay: 1400
      }
    };

    /**
     * Tenta abrir o primeiro scheme que “parece” válido.
     * Se não abrir (página continua visível), faz fallback.
     * @param {Object} cfg
     * @param {Boolean} openInNewTab
     */
    function openService(cfg, newTabFallback = false) {
      if (!isMobile) {
    // Desktop: já abre direto o site em nova aba se pediram newTabFallback
    if (newTabFallback) {
      window.open(cfg.web, '_blank', 'noopener');
    } else {
      window.location.href = cfg.web;
    }
    return;
  }

      // Escolhe primeiro candidato de scheme
      const scheme = (cfg.schemeCandidates || []).find(Boolean);
  if (!scheme) {
    if (newTabFallback) {
      window.open(cfg.web, '_blank', 'noopener');
    } else {
      window.location.href = cfg.web;
    }
    return;
  }

  let wentBackground = false;

  const onVis = () => {
    if (document.hidden) wentBackground = true;
  };
  const onPageHide = () => { wentBackground = true; };

  document.addEventListener('visibilitychange', onVis, { once: true });
  window.addEventListener('pagehide', onPageHide, { once: true });

  // Tenta abrir o app (iOS e Android igualmente)
  try { window.location = scheme; } catch(e) {}

  setTimeout(() => {
    if (!wentBackground) {
      if (newTabFallback) {
        window.open(cfg.web, '_blank', 'noopener');
      } else {
        window.location.href = cfg.web;
      }
    }
    cleanup();
  }, cfg.fallbackDelay || 1200);

  function cleanup() {
    document.removeEventListener('visibilitychange', onVis);
    window.removeEventListener('pagehide', onPageHide);
  }
}

/* Helper: lê atributo data-open-new-tab */
function wantsNewTab(el) {
  return el?.getAttribute('data-open-new-tab') === '1';
}

/* Ligações */
document.getElementById('qrBtn')?.addEventListener('click', () => {
  window.location.href = window.APP_CONFIG.urls.scanTruss;
});
document.getElementById('inventoryBtn')?.addEventListener('click', e => {
  openService(SERVICES.inventory, wantsNewTab(e.currentTarget));
});
document.getElementById('fieldwireBtn')?.addEventListener('click', e => {
  openService(SERVICES.fieldwire, wantsNewTab(e.currentTarget));
});
document.getElementById('asanaBtn')?.addEventListener('click', e => {
  openService(SERVICES.asana, wantsNewTab(e.currentTarget));
});
document.getElementById('reportBtn')?.addEventListener('click', e => {
  openService(SERVICES.reports, wantsNewTab(e.currentTarget));
});
</script>
</body>
</html>